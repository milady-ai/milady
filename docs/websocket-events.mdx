---
title: WebSocket Real-Time Events
sidebarTitle: WebSocket Events
description: Reference for the Milaidy WebSocket protocol, connection details, event types, and payloads.
---

# WebSocket Real-Time Events

Milaidy uses WebSocket connections to deliver real-time updates from the agent runtime to connected clients (the frontend UI, Electron, or any custom integration).

## Connection

### API Server WebSocket

<CodeGroup>
```text Default
ws://localhost:2138/ws
```

```text Gateway
ws://localhost:18789/ws
```
</CodeGroup>

The WebSocket endpoint is available at `/ws` on the API server (port 2138) or through the Gateway (port 18789 by default).

### Authentication

When `MILAIDY_API_TOKEN` is configured, the WebSocket upgrade request must include the token. The server calls `resolveWebSocketUpgradeRejection()` to validate credentials before accepting the connection. Unauthenticated upgrade requests receive an HTTP 401 or 403 rejection.

<Warning>
If token auth is enabled and the WebSocket upgrade request lacks valid credentials, the connection will be rejected with a standard HTTP error before the WebSocket handshake completes.
</Warning>

## Connection Lifecycle

### On Connect

When a WebSocket client connects, the server immediately sends:

1. A `status` event with the current agent state
2. A replay of the last 120 buffered stream events (agent events + heartbeat events)

```json
{
  "type": "status",
  "state": "running",
  "agentName": "Milady",
  "model": "@elizaos/plugin-anthropic",
  "startedAt": 1708000000000
}
```

### Periodic Broadcasts

The server broadcasts a `status` event to all connected clients every **5 seconds**.

### Keepalive

Clients can send a `ping` message; the server responds with a `pong`:

<Tabs>
  <Tab title="Client sends">
    ```json
    { "type": "ping" }
    ```
  </Tab>
  <Tab title="Server responds">
    ```json
    { "type": "pong" }
    ```
  </Tab>
</Tabs>

## Client-to-Server Messages

| Message Type | Payload | Description |
|-------------|---------|-------------|
| `ping` | `{}` | Keepalive ping; server responds with `pong` |
| `active-conversation` | `{ conversationId: string }` | Inform the server which conversation is currently active in the UI |

### Active Conversation Tracking

```json
{
  "type": "active-conversation",
  "conversationId": "conv-abc-123"
}
```

The server uses this to decide whether to deliver proactive messages inline (active conversation) or mark them as unread (non-active conversation).

## Server-to-Client Events

### `status`

Broadcast every 5 seconds and on state changes.

```json
{
  "type": "status",
  "state": "running",
  "agentName": "Milady",
  "model": "@elizaos/plugin-anthropic",
  "startedAt": 1708000000000,
  "pendingRestart": false,
  "pendingRestartReasons": []
}
```

| Field | Type | Description |
|-------|------|-------------|
| `state` | `string` | One of: `not_started`, `starting`, `running`, `paused`, `stopped`, `restarting`, `error` |
| `agentName` | `string` | Current agent display name |
| `model` | `string \| undefined` | Detected AI model provider plugin name |
| `startedAt` | `number \| undefined` | Epoch timestamp when the agent was started |
| `pendingRestart` | `boolean` | Whether a restart is pending |
| `pendingRestartReasons` | `string[]` | Human-readable reasons why a restart is needed |

### `restart-required`

Sent when the server detects that a configuration change requires a restart.

```json
{
  "type": "restart-required",
  "reasons": ["Shell access enabled", "Plugin configuration changed"]
}
```

### `agent_event`

Envelope for agent autonomy loop events streamed from the `AGENT_EVENT` service.

```json
{
  "type": "agent_event",
  "version": 1,
  "eventId": "evt-42",
  "ts": 1708000000000,
  "runId": "run-xyz",
  "seq": 42,
  "stream": "autonomy",
  "sessionKey": "session-key",
  "agentId": "agent-uuid",
  "roomId": "room-uuid",
  "payload": {}
}
```

| Field | Type | Description |
|-------|------|-------------|
| `version` | `1` | Envelope format version |
| `eventId` | `string` | Unique event identifier (format: `evt-{N}`) |
| `ts` | `number` | Epoch timestamp |
| `runId` | `string \| undefined` | Autonomy run identifier |
| `seq` | `number \| undefined` | Sequence number within the run |
| `stream` | `string \| undefined` | Event stream name (e.g., `"autonomy"`, `"assistant"`) |
| `sessionKey` | `string \| undefined` | Session key |
| `agentId` | `string \| undefined` | Agent UUID |
| `roomId` | `string \| undefined` | Room UUID |
| `payload` | `object` | Inner event data from the agent runtime |

### `heartbeat_event`

Envelope for agent heartbeat events (activity indicators).

```json
{
  "type": "heartbeat_event",
  "version": 1,
  "eventId": "evt-43",
  "ts": 1708000000000,
  "payload": {
    "ts": 1708000000000,
    "status": "thinking",
    "to": "discord",
    "preview": "Composing reply...",
    "durationMs": 1500,
    "hasMedia": false,
    "channel": "discord",
    "indicatorType": "typing"
  }
}
```

| Payload Field | Type | Description |
|--------------|------|-------------|
| `status` | `string` | Heartbeat status (e.g., `"thinking"`, `"replying"`) |
| `to` | `string` | Target channel/destination |
| `preview` | `string` | Short preview of what the agent is doing |
| `durationMs` | `number` | Duration of the current operation |
| `hasMedia` | `boolean` | Whether the operation involves media |
| `channel` | `string` | Channel identifier |
| `silent` | `boolean` | Whether this is a silent heartbeat |
| `indicatorType` | `string` | UI indicator type (e.g., `"typing"`) |

### `training_event`

Envelope for fine-tuning/training progress events.

```json
{
  "type": "training_event",
  "version": 1,
  "eventId": "evt-44",
  "ts": 1708000000000,
  "payload": {}
}
```

### `proactive-message`

Sent when the agent autonomously generates a message in a conversation.

```json
{
  "type": "proactive-message",
  "conversationId": "conv-abc-123",
  "message": {
    "id": "msg-uuid",
    "role": "assistant",
    "text": "I noticed something interesting...",
    "timestamp": 1708000000000,
    "source": "autonomy"
  }
}
```

| Message Field | Type | Description |
|--------------|------|-------------|
| `id` | `string` | Message UUID |
| `role` | `string` | Always `"assistant"` |
| `text` | `string` | Message content |
| `timestamp` | `number` | Epoch timestamp (milliseconds) |
| `source` | `string` | Origin of the message (e.g., `"autonomy"`) |

The frontend handles this by:
- Appending the message in real-time if the conversation is active
- Marking the conversation as unread if it is not active
- Bumping the conversation to the top of the sidebar

### `conversation-updated`

Sent when conversation metadata changes (e.g., title auto-generated from first message).

```json
{
  "type": "conversation-updated",
  "conversation": {
    "id": "conv-abc-123",
    "title": "Discussion about AI agents",
    "roomId": "room-uuid",
    "createdAt": "2024-02-15T10:00:00.000Z",
    "updatedAt": "2024-02-15T10:30:00.000Z"
  }
}
```

## Reconnection Behavior

The frontend API client (`apps/app/src/api-client.ts`) handles reconnection automatically via its `connectWs()` method. The reconnection strategy uses exponential backoff with these hardcoded parameters:

| Parameter | Value | Description |
|-----------|-------|-------------|
| Initial delay | 500ms | Delay before first reconnection attempt |
| Backoff factor | 1.5x | Multiplier applied after each failed attempt |
| Max delay | 10,000ms | Maximum delay between reconnection attempts |
| Max attempts | unlimited | Reconnection never stops trying |

On successful reconnect, the `backoffMs` resets to 500ms.

<Tip>
On reconnect, the server replays the last 120 buffered events, so clients can catch up on missed events without a full page refresh.
</Tip>

## Event Buffer

The server maintains an in-memory event buffer for stream events. Key characteristics:

- `agent_event`, `heartbeat_event`, and `training_event` types are buffered
- Last 120 events are replayed to newly connected clients
- The buffer is capped at 1,500 events; older events are pruned automatically
