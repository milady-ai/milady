# Nixpacks build configuration for Sevalla deployment
# Uses npm for dependency install (no bun.lock in repo, bun resolution OOMs).
# Bun added via Nix for build scripts that require it (postinstall, build).

[variables]
NIXPACKS_SPA_CADDY    = "false"
NODE_ENV              = "production"
NPM_CONFIG_PRODUCTION = "false"

# Pin Node 22 + Bun via Nix packages. "..." preserves auto-detected packages.
[phases.setup]
nixPkgs = ["...", "nodejs_22", "bun"]

# npm handles dependency resolution reliably without a lockfile.
# --legacy-peer-deps works around @capacitor/core peer dep conflicts.
# postinstall hooks call bun (available from Nix setup phase).
[phases.install]
cmds = ["npm install --legacy-peer-deps"]

# Full build: compile agent runtime (tsdown) + web UI (Vite)
[phases.build]
cmds = ["bun run build"]

# Start the agent server. Sevalla injects PORT at runtime.
[start]
cmd = "MILADY_PORT=${PORT:-2138} MILADY_API_BIND=0.0.0.0 node milady.mjs start"
