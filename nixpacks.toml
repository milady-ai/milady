# Nixpacks build configuration for Sevalla deployment
# No bun.lock in repo, so Nixpacks won't auto-detect Bun.
# Use npm with --legacy-peer-deps to handle Capacitor peer dep conflicts.

[variables]
NIXPACKS_SPA_CADDY    = "false"
NODE_ENV              = "production"
NPM_CONFIG_PRODUCTION = "false"

# Pin Node 22 + system libs needed by native modules
[phases.setup]
nixPkgs = ["...", "nodejs_22"]

# npm install with legacy peer deps to avoid ERESOLVE errors
[phases.install]
cmds = ["npm install --legacy-peer-deps"]

# Full build: compile agent runtime (tsdown) + web UI (Vite)
[phases.build]
cmds = ["npm run build"]

# Start the agent server. Sevalla injects PORT at runtime.
[start]
cmd = "MILADY_PORT=${PORT:-2138} MILADY_API_BIND=0.0.0.0 node milady.mjs start"
