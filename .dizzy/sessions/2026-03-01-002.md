# Session 2026-03-01-002 — Electron → Electrobun Migration

## Summary

Replaced the entire `apps/app/electron/` workspace with `apps/app/electrobun/`,
migrating the Milady desktop app from Electron to Electrobun
(https://github.com/blackboardsh/electrobun).

This was a full migration — the user accepted that camera, screen capture,
Whisper, and local LLM features would be temporarily broken or dropped.

## Architecture

The core challenge was IPC parity: Electron's `ipcMain`/`ipcRenderer` pattern
has no direct Electrobun equivalent without modifying the React app. Solution:

**WebSocket IPC Bridge** — Bun serves the React app at `localhost:18999` with
a `window.electron` shim injected into `<head>` before any page scripts. The
shim creates a WebSocket connection to the same port and implements the full
`window.electron.ipcRenderer` API (invoke, send, on, once, removeListener,
removeAllListeners), plus `desktopCapturer.getSources` and `platform`. All IPC
routes through JSON messages over WebSocket; no React code needed to change.

Push events (`mainWindow.webContents.send`) → `pushToRenderer(channel, data)`
API injection (`executeJavaScript`) → `executeJavascript(script)` over WS eval

## Files Modified

| File | Change |
|------|--------|
| `package.json` | workspace `apps/app/electron` → `apps/app/electrobun`; fixed `dev:desktop`, `build:desktop`, `start:desktop` scripts; removed Electron root deps |
| `apps/app/package.json` | removed Electron/Capacitor Electron scripts; simplified `build:electron` |

## Files Created (`apps/app/electrobun/`)

| File | Purpose |
|------|---------|
| `package.json` | Electrobun workspace; deps: electrobun ^1.14.4, bonjour-service, chokidar |
| `electrobun.config.ts` | App metadata, CEF bundling, release config, `milady://` URL scheme |
| `tsconfig.json` | ESNext + bun-types |
| `src/index.ts` | Main Bun entry: IPC server, BrowserWindow, agent startup, auto-updater, SIGTERM/SIGINT |
| `src/ipc-server.ts` | Bun HTTP+WS server; handle(), pushToRenderer(), executeJavascript(), buildShim() |
| `src/api-base.ts` | resolveExternalApiBase(), injectApiBase(), pushSharePayload() |
| `src/native/agent.ts` | AgentManager — Bun-native paths, dynamic import of milady-dist |
| `src/native/desktop.ts` | DesktopManager — Tray, GlobalShortcut, window mgmt via Electrobun APIs |
| `src/native/gateway.ts` | GatewayDiscovery — mDNS/Bonjour via bonjour-service |
| `src/native/permissions.ts` | PermissionManager — permission check/request with pushToRenderer |
| `src/native/permissions-darwin.ts` | macOS permissions via osascript (no Electron desktopCapturer/systemPreferences) |
| `src/native/permissions-linux.ts` | Copied unchanged |
| `src/native/permissions-win32.ts` | Copied unchanged |
| `src/native/permissions-shared.ts` | Copied unchanged |
| `src/native/ipc-channels.ts` | Copied unchanged (124+ channel constants) |
| `src/native/ipc-types.ts` | Copied unchanged (IpcValue type) |
| `src/native/index.ts` | Aggregates all handler maps; registerAllIPC(); initializeNativeModules() |
| `src/native/camera.ts` | STUB — returns not-available |
| `src/native/screencapture.ts` | STUB — returns not-available |
| `src/native/talkmode.ts` | STUB — returns not-available |
| `src/native/swabble.ts` | STUB — returns not-available |
| `src/native/canvas.ts` | STUB — returns not-available |
| `src/native/location.ts` | STUB — returns not-available |
| `src/native/whisper.ts` | STUB — not available in Electrobun yet |
| `assets/appIcon.png` | Recovered from old electron/assets/ |
| `assets/appIcon.ico` | Recovered from old electron/assets/ |

## Files Deleted

`apps/app/electron/` — entire directory (65+ files, ~8500 lines removed):
- `src/index.ts`, `src/preload.ts`, `src/setup.ts`, `src/web-assets.ts`, `src/api-base.ts`
- `src/native/` — all 18 native modules
- `src/permissions/` — registry.ts, types.ts
- `src/rt/` — electron-plugins.js, electron-rt.ts
- `package.json`, `tsconfig.json`, `electron-builder.config.json`
- `capacitor.config.ts`, `capacitor.config.json`, `capacitor.shared.ts`
- `assets/`, `resources/`, `scripts/`, `data/`

## Decisions Made

- **WebSocket IPC bridge** over Electrobun's typed RPC — preserves 100% React
  app compatibility without modifying any `window.electron.*` call sites
- **Fixed port 18999** (configurable via `MILADY_DESKTOP_PORT`) — shim is
  regenerated per request so port is baked in dynamically
- **CEF renderer** (`renderer: "cef"`) — maintains Chromium parity across
  platforms; system webview would require more UI testing
- **`bundleCEF: true`** in all platform configs — same reasoning
- **Stubs** for camera, screencapture, talkmode, swabble, canvas, location,
  whisper — all return `{error: "not-available", code: "NOT_AVAILABLE"}` to
  React handlers rather than crashing
- **Capacitor Electron bridge dropped** — `@capacitor-community/electron`,
  `CapElectronEventEmitter`, `setupCapacitorElectronPlugins` all removed; the
  React app's `window.electron` surface is fully covered by the WS shim
- **Heavy native deps removed** from desktop workspace: tensorflow, llama-cpp,
  onnxruntime, whisper-node, canvas, sharp, node-pty
- **macOS permissions** — osascript/AppleScript replaces `desktopCapturer`,
  `systemPreferences.askForMediaAccess()`, and `shell.openExternal()`
- **Auto-launch** — osascript on macOS, `.desktop` file creation on Linux
  (no direct Electrobun API, so shell-based approach)

## Known Issues

1. **Electrobun API surface** — Electrobun is pre-1.0; some APIs used
   (Tray, GlobalShortcut, Utils.exec, Updater) may not be stable. Verify
   against `electrobun@1.14.4` docs before first build attempt.
2. **`getDesktopManager()` getPort loop** — index.ts has a `setInterval`
   calling `getAgentManager().getPort()` unconditionally even when
   `skipEmbeddedAgent` is true; harmless but slightly wasteful.
3. **Camera/screencapture stubs** — the React app may show error states
   for features that depend on these (LIFO stream, screen share, etc.)
4. **Deep linking on Linux** — `milady://` URL scheme registration not
   implemented in Electrobun config for Linux; may need `.desktop` file update.
5. **Assets gitignore** — root `.gitignore` has `assets/` pattern; forced
   `git add -f` for the icons. Future assets in this dir need the same.

## Next Steps

1. `cd apps/app/electrobun && bun install` — install electrobun and deps
2. `bun run dev:desktop` — attempt first dev launch
3. Fix any TypeScript errors from Electrobun type mismatches
4. Verify Tray, GlobalShortcut, BrowserWindow APIs against installed version
5. Test IPC round-trip: React invoke → WS → handler → response
6. Implement camera/screencapture when Electrobun gains native media APIs
7. Add `milady://` deep link registration for Linux

---

## Session Continuation — 2026-03-02

### TypeScript Fixes (post-commit follow-up)

Ran `bun x tsc --noEmit` and fixed all type errors in the electrobun workspace.

**Issues fixed:**
- `@types/bun` missing → added as devDep; tsconfig `types` updated from `bun-types`
- `BrowserWindow.getAll()` / `Tray.getAll()` don't exist → use `InstanceType<typeof T>`
- `buildMenuItems` return type didn't satisfy `MenuItemConfig[]` discriminated union
- `exec({detached})` invalid in ExecOptions → switched to `spawn({detached}).unref()`
- Clipboard Utils functions are synchronous → removed `await` / `.catch()` calls
- `desktop:setTrayMenu` handler returned `void` not `Promise<unknown>` → `Promise.resolve()`
- `gateway.ts`: `parseBoolean`/`parseNumber` missing from class → added private methods
- `gateway.ts`: mdns dynamic import has no types → added `@ts-ignore`
- `gateway.ts`: bonjour-service cast needed `unknown` intermediary
- `permissions-linux/win32.ts`: had `import { shell } from "electron"` → replaced with execAsync
- `ipc-server.ts`: `srv.upgrade(req)` needed second `{ data }` arg per bun types
- `index.ts`: `new Updater()` → `Updater.checkForUpdate()` (Updater is an object not class)
- `desktop.ts`: `paths.userData` → `paths.appData` (Electrobun has no userData path)
- **Electrobun upstream bugs**: Updater.ts has 3 internal TS2554 errors (their bug).
  Fixed by creating `src/types/electrobun.d.ts` type shim + tsconfig `paths` override
  so tsc uses our declarations instead of following into the buggy package source.
  Bun's runtime is unaffected (paths only affect TypeScript resolution).

**Result**: `bun x tsc --noEmit` → zero errors.

**New commit**: `b72115cb` — fix(desktop): resolve all TypeScript errors in electrobun workspace
